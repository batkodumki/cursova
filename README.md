# Метод експертних попарних порівнянь з уточненням ступеня переваги

Реалізація адаптивного методу експертних оцінок для підтримки прийняття рішень.

## Опис

Система реалізує метод попарних порівнянь з можливістю адаптивного вибору шкал оцінювання для кожного окремого порівняння. Базується на наукових публікаціях та документі **Opys_Рівень.doc**:

- **РЗОД-2011-2.pdf**: Концепція адаптивних систем підтримки прийняття рішень, покрокове уточнення ступеня переваги
- **РЗОД-2011-3.pdf**: Вибір шкал експертного оцінювання (рівно **6 шкал**: ординальна, цілочислова/Сааті-9, збалансована, степенева, Ма-Чженга, Донегана-Додд-МакМастера)
- **РЗОД-2011-4.pdf**: Уніфікація оцінок до кардинальної шкали 1.5-9.5, спектральний показник узгодженості, агрегація
- **РЗОД-2012-1.pdf**: Практичні рекомендації та приклади

## Основні можливості

### 1. Адаптивний вибір шкал (рівно 6 шкал згідно РЗОД-2011-3.pdf)

Реалізовано **рівно 6 шкал** експертного оцінювання:

1. **Ординальна** (2 градації) - проста бінарна перевага
2. **Цілочислова/Сааті-9** (3-9 градацій) - класична шкала Сааті з цілими числами [1, 2, 3, ..., 9]
3. **Збалансована** (3-9 градацій) - формула w/(1-w) для рівномірного розподілу
4. **Степенева** (3-9 градацій) - формула 9^((i-1)/(n-1)) для експоненційного зростання
5. **Ма-Чженга** (3-9 градацій) - формула n/(n+1-i) з таблиці 5 РЗОД-2011-3.pdf
6. **Донегана-Додд-МакМастера** (3-9 градацій) - tanh-based формула з таблиці 6 РЗОД-2011-3.pdf

Експерт може обирати різні шкали для **кожного окремого порівняння** з можливістю **покрокового уточнення** ступеня переваги.

### 2. Уніфікація до єдиної кардинальної шкали (РЗОД-2011-4.pdf)
Всі оцінки з різних шкал уніфікуються до єдиної кардинальної шкали з межами **1.5 до 9.5**.

Формула центрів інтервалів: **M_i^n = 1.5 + (i - 0.5) × 8 / n**, де:
- 1.5 - нижня межа кардинальної шкали
- 9.5 - верхня межа кардинальної шкали
- n - кількість градацій вихідної шкали
- i - номер градації (1, 2, 3, ..., n)

Журнал трансформацій експортується у файл **scale_transformations.json** для відстеження процесу уніфікації.

### 3. Робота з неповними матрицями
- Перевірка зв'язності графу порівнянь
- Автоматичне заповнення через транзитивність
- Підтримка мінімально необхідних порівнянь

### 4. Оцінка узгодженості
- Розрахунок максимального власного значення **λ_max**
- Індекс узгодженості **CI = (λ_max - n) / (n - 1)**
- Відношення узгодженості **CR = CI / RI**
- Критерій: **CR < 0.10** для прийнятної узгодженості

### 5. Зворотний зв'язок з експертом
- Генерація рекомендацій для неузгоджених оцінок
- Побудова ідеальної узгодженої МПП
- Визначення порівнянь з найбільшим відхиленням

### 6. Групова агрегація
- Зважування за інформативністю шкали: **I = log₂ N** (формула Хартлі)
- Зважування за коефіцієнтами компетентності експертів
- Геометричне середнє зважене для комбінування оцінок

### 7. Розрахунок вагових коефіцієнтів
- Метод власного вектора
- Метод геометричного середнього рядків
- Ранжування альтернатив

## Структура проекту

```
cursova/
├── scales.py              # Визначення шкал, уніфікація
├── pcm.py                 # Матриці попарних порівнянь (МПП)
├── consistency.py         # Оцінка узгодженості, рекомендації
├── aggregate.py           # Групова агрегація
├── main.py                # CLI інтерфейс
├── gui/                   # GUI застосунок
│   ├── app.py            # Точка входу GUI
│   ├── models.py         # Адаптери до основних модулів
│   ├── views.py          # Візуальні компоненти
│   ├── controllers.py    # Контролери (MVC)
│   └── __init__.py       # Пакет ініціалізація
├── input_example.json     # Приклад вхідних даних
├── requirements.txt       # Залежності
└── README.md              # Документація
```

## Встановлення

### Вимоги
- Python 3.10 або вище
- pip

### Крок 1: Клонування репозиторію
```bash
git clone <repository_url>
cd cursova
```

### Крок 2: Встановлення залежностей
```bash
pip install -r requirements.txt
```

## Використання

### GUI Застосунок (Рекомендовано)

Запуск графічного інтерфейсу:

```bash
python -m gui.app
```

або:

```bash
python gui/app.py
```

#### Робочий процес GUI:

1. **Стартове вікно**
   - "Нова експертиза" - створити новий проект
   - "Відкрити існуючу..." - завантажити збережену сесію

2. **Налаштування проекту**
   - Введіть альтернативи (одна на рядок)
   - Можна завантажити з CSV або використати приклад
   - Додайте експертів з коефіцієнтами компетентності
   - Натисніть "Почати порівняння"

3. **Парні порівняння**
   - Для кожної пари альтернатив:
     - Оберіть шкалу з 6 доступних (Ординальна, Цілочислова/Сааті-9, Збалансована, Степенева, Ма-Чженга, Донегана)
     - Використовуйте слайдер для вибору градації
     - Лінгвістичні фрази допоможуть зробити вибір
     - Можна уточнити ступінь переваги (збільшити детальність шкали: 2→3→5→7→9)
     - Кнопки: "Назад", "Пропустити", "Підтвердити"
   - Гарячі клавіші:
     - ← → - рух по градаціях
     - Enter - підтвердити оцінку
   - Індикатор прогресу показує кількість виконаних порівнянь
   - Відображається інформативність обраної шкали (I = log₂ N біт)

4. **Результати**
   - Вкладка "Ваги та ранжування" - таблиця з вагами альтернатив
   - Вкладка "Узгодженість" - показники λ_max, CI, CR
   - Вкладка "Рекомендації" - пропозиції покращення узгодженості
   - Кнопка "Експорт результатів" - збереження всіх файлів (CSV, JSON)
   - Кнопка "Зберегти сесію" - збереження для продовження пізніше

#### Особливості GUI:

- **Адаптивне уточнення**: можливість покрокового збільшення детальності шкали
- **Групова експертиза**: підтримка кількох експертів з різними коефіцієнтами компетентності
- **Візуальні підказки**: числові еквіваленти та інформативність шкали
- **Збереження прогресу**: можна зберегти сесію та продовжити пізніше
- **Автоматичне заповнення**: неповні МПП заповнюються через транзитивність
- **Експорт результатів**: weights.csv, consistency.json, suggestions.json, scale_transformations.json

### CLI Інтерфейс

Запуск з прикладом через командний рядок:

```bash
python main.py --input input_example.json --out out/
```

### Формат вхідних даних (JSON)

```json
{
  "alternatives": ["Проект_A", "Проект_B", "Проект_C", "Проект_D"],
  "experts": [
    {
      "expert_id": "Експерт_1",
      "judgments": [
        {
          "alt_i": "Проект_A",
          "alt_j": "Проект_B",
          "value": 5.0,
          "scale_type": "saaty_9",
          "n_gradations": 9
        }
      ]
    }
  ],
  "competence_coefficients": {
    "Експерт_1": 0.85,
    "Експерт_2": 0.60
  }
}
```

#### Параметри оцінок
- `alt_i`, `alt_j`: Назви альтернатив для порівняння
- `value`: Значення на вихідній шкалі
- `scale_type`: Тип шкали (рівно **6 варіантів**):
  - `"ordinal"` - ординальна (2 градації)
  - `"saaty_9"` - цілочислова/Сааті-9 (3-9 градацій) - класична
  - `"balanced"` - збалансована (3-9 градацій)
  - `"power"` - степенева (3-9 градацій)
  - `"ma_zheng"` - Ма-Чженга (3-9 градацій)
  - `"donegan"` - Донегана-Додд-МакМастера (3-9 градацій)
- `n_gradations`: Кількість градацій (2 для ординальної, 3-9 для інших)

### Вихідні файли

Після виконання в директорії `out/` створюються:

#### 1. `weights.csv`
Вагові коефіцієнти та ранжування альтернатив:
```csv
alternative,weight,rank
Проект_A,0.5123,1
Проект_B,0.2789,2
...
```

#### 2. `consistency.json`
Звіт про узгодженість:
```json
{
  "consistency_analysis": {
    "lambda_max": 4.1234,
    "CI": 0.0411,
    "CR": 0.0457,
    "is_consistent": true
  },
  "aggregated_matrix": [[1, 3, 5, 7], ...]
}
```

#### 3. `suggestions.json`
Рекомендації для покращення узгодженості (якщо CR ≥ 0.10):
```json
[
  {
    "comparison": "Проект_A vs Проект_B",
    "current_value": 3.0,
    "suggested_value": 4.2,
    "deviation_percent": 28.5,
    "message": "Рекомендується переглянути..."
  }
]
```

#### 4. `scale_transformations.json`
Журнал трансформацій шкал:
```json
[
  {
    "expert_id": "Експерт_1",
    "comparison": "Проект_A vs Проект_B",
    "original_scale": "saaty_9",
    "n_gradations": 9,
    "original_value": 5.0,
    "unified_value": 5,
    "informativeness": 3.169925
  }
]
```

## Приклад використання

### Вхідні дані
4 альтернативи (проекти), 2 експерти:
- **Експерт_1**: компетентність 0.85, шкала Сааті-9 (I ≈ 3.17 біт)
- **Експерт_2**: компетентність 0.60, шкала Сааті-5 (I ≈ 2.32 біт)

### Процес обробки
1. Побудова МПП для кожного експерта
2. Уніфікація оцінок до шкали 1-9
3. Заповнення неповних МПП (якщо потрібно)
4. Оцінка узгодженості (λ_max, CI, CR)
5. Агрегація з вагами:
   - Експерт_1: 3.17 × 0.85 ≈ 2.69
   - Експерт_2: 2.32 × 0.60 ≈ 1.39
6. Розрахунок вагових коефіцієнтів
7. Ранжування альтернатив

### Очікувані результати
- Агрегована МПП з узгодженістю CR < 0.10
- Вагові коефіцієнти для 4 альтернатив
- Рекомендації для покращення (якщо потрібно)

## Модулі та API

### `scales.py`
- `get_scale_values(scale_type, n_gradations)` - значення шкали
- `unify_to_cardinal(scale_type, n_gradations, grade_index)` - уніфікація
- `calculate_informativeness(n_gradations)` - інформативність I = log₂ N
- `unify_judgment(scale_type, n_gradations, value)` - уніфікація оцінки

### `pcm.py`
- `PairwiseComparisonMatrix` - клас для МПП
- `add_judgment(alt_i, alt_j, value, scale_type, n_gradations)` - додати оцінку
- `fill_transitive()` - заповнити через транзитивність
- `check_connectivity()` - перевірка зв'язності

### `consistency.py`
- `consistency_spectral(matrix)` - спектральний аналіз узгодженості
- `calculate_weights_eigenvector(matrix)` - ваги (власний вектор)
- `calculate_weights_geometric_mean(matrix)` - ваги (геометричне середнє)
- `ideal_pcm(weights)` - ідеальна узгоджена МПП
- `generate_revision_suggestions(matrix, alternatives)` - рекомендації
- `rank_weights(weights, alternatives)` - ранжування

### `aggregate.py`
- `group_aggregate(pcm_list, competence_coefficients)` - групова агрегація
- `calculate_expert_weights(pcm_list, competence_coefficients)` - ваги експертів
- `aggregate_with_statistics(pcm_list, competence_coefficients)` - агрегація зі статистикою

## Тестування

Модулі містять doctest приклади. Запуск тестів:

```bash
python -m doctest scales.py -v
python -m doctest pcm.py -v
python -m doctest consistency.py -v
python -m doctest aggregate.py -v
```

Демонстрація роботи модулів:

```bash
python scales.py
python pcm.py
python consistency.py
python aggregate.py
```

## Таблиця відповідності вимогам (Requirements Mapping)

Цей розділ показує відповідність між вимогами з документів Opys_Рівень.doc та РЗОД-2011-2/3/4.pdf і їх реалізацією у коді.

| Вимога з документації | Джерело | Реалізація у коді | Файл/Модуль |
|----------------------|---------|-------------------|-------------|
| **Шкали та уніфікація** |
| Рівно 6 типів шкал оцінювання | РЗОД-2011-3.pdf, табл. 5-6 | `class ScaleType(Enum)` з 6 значеннями: ORDINAL, SAATY_9, BALANCED, POWER, MA_ZHENG, DONEGAN | `scales.py:14-21` |
| Ординальна шкала (2 градації) | РЗОД-2011-3.pdf | `ScaleType.ORDINAL`, значення [1.0, 9.0] | `scales.py:51-52` |
| Цілочислова шкала Сааті (3-9 градацій) | РЗОД-2011-3.pdf, табл. 3 | `ScaleType.SAATY_9`, значення [1, 2, ..., 9] | `scales.py:55-56` |
| Збалансована шкала (3-9 градацій) | РЗОД-2011-3.pdf, табл. 4 | `ScaleType.BALANCED`, формула `w/(1-w)` | `scales.py:59-64` |
| Степенева шкала (3-9 градацій) | РЗОД-2011-3.pdf, табл. 4 | `ScaleType.POWER`, формула `9^((i-1)/(n-1))` | `scales.py:67-69` |
| Шкала Ма-Чженга (3-9 градацій) | РЗОД-2011-3.pdf, табл. 5 | `ScaleType.MA_ZHENG`, формула `n/(n+1-i)` | `scales.py:72-74` |
| Шкала Донегана-Додд-МакМастера | РЗОД-2011-3.pdf, табл. 6 | `ScaleType.DONEGAN`, tanh-based формула | `scales.py:77-82` |
| Уніфікація до кардинальної шкали 1.5-9.5 | РЗОД-2011-4.pdf, формула (4) | `unify_to_cardinal()`, формула `M_i^n = 1.5 + (i - 0.5) × 8 / n` | `scales.py:105-135` |
| Журнал трансформацій шкал | РЗОД-2011-4.pdf | `create_transformation_log()`, експорт у `scale_transformations.json` | `scales.py:177-194`, `controllers.py:281-304` |
| **Покрокове уточнення** |
| Покрокове уточнення ступеня переваги | Opys_Рівень.doc, РЗОД-2011-2.pdf | `suggest_scale_refinement()`, прогресія: ординальна(2) → Сааті-9(3→5→7→9) | `models.py:418-451` |
| Інформативність шкали (формула Хартлі) | РЗОД-2011-2.pdf | `calculate_informativeness()`, формула `I = log₂(N)` | `scales.py:157-171` |
| Кнопка уточнення у GUI | Opys_Рівень.doc | Кнопка "Уточнити ступінь (збільшити детальність)" | `views.py:379-384`, `views.py:478-500` |
| **Матриці попарних порівнянь (МПП)** |
| Створення МПП з уніфікацією оцінок | РЗОД-2011-4.pdf | `class PairwiseComparisonMatrix`, метод `add_judgment()` | `pcm.py:26-104` |
| Зворотна симетрія a_ji = 1/a_ij | РЗОД-2011-3.pdf, РЗОД-2011-4.pdf | Автоматичне встановлення при `add_judgment()` | `pcm.py:98-103` |
| Підтримка неповних МПП | РЗОД-2011-2.pdf | `PCMStatus.INCOMPLETE`, метод `get_status()` | `pcm.py:19-24`, `pcm.py:105-126` |
| Перевірка зв'язності графу | РЗОД-2011-2.pdf, РЗОД-2012-1.pdf | `check_connectivity()`, DFS алгоритм | `pcm.py:128-164` |
| Заповнення через транзитивність | РЗОД-2011-2.pdf | `fill_transitive()`, формула a_ik = a_ij × a_jk | `pcm.py:166-213` |
| **Узгодженість** |
| Спектральний показник узгодженості | РЗОД-2011-4.pdf | `consistency_spectral()`, розрахунок λ_max, CI, CR | `consistency.py:13-72` |
| Індекс узгодженості CI | Saaty 1980 | `CI = (λ_max - n) / (n - 1)` | `consistency.py:50` |
| Відношення узгодженості CR | Saaty 1980 | `CR = CI / RI`, поріг CR < 0.10 | `consistency.py:56-60` |
| Випадковий індекс RI | Saaty 1980 | Таблиця RI для n=1..15 | `consistency.py:75-80` |
| Рекомендації для покращення узгодженості | РЗОД-2011-4.pdf | `generate_revision_suggestions()`, порівняння з ідеальною МПП | `consistency.py:166-253` |
| Ідеальна узгоджена МПП | РЗОД-2011-4.pdf | `ideal_pcm()`, формула a_ij = w_i / w_j | `consistency.py:137-163` |
| **Агрегація** |
| Групова агрегація експертних оцінок | РЗОД-2011-4.pdf | `group_aggregate()`, геометричне середнє зважене | `aggregate.py:14-89` |
| Вага експерта: w = I × c_l | РЗОД-2011-4.pdf | `calculate_expert_weights()`, формула `I × competence` | `aggregate.py:92-127` |
| Геометричне середнє зважене | РЗОД-2012-1.pdf | Формула `GM = (∏ v_i^w_i)^(1/∑w_i)` | `aggregate.py:53-63` |
| Статистика експертних оцінок | РЗОД-2012-1.pdf | Середнє, мінімум, максимум, std для кожної пари | `aggregate.py:130-189` |
| **Вагові коефіцієнти** |
| Метод власного вектора | Saaty 1980, РЗОД-2011-4.pdf | `calculate_weights_eigenvector()` | `consistency.py:89-113` |
| Метод геометричного середнього рядків | Saaty 1980 | `calculate_weights_geometric_mean()` | `consistency.py:116-134` |
| Ранжування альтернатив | РЗОД-2011-4.pdf | `rank_weights()` | `consistency.py:256-282` |
| **GUI Застосунок** |
| Екран 1: Введення альтернатив та експертів | Opys_Рівень.doc | `class ProjectSetupWindow` | `views.py:64-253` |
| Екран 2: Парні порівняння з вибором шкали | Opys_Рівень.doc | `class ComparisonWindow` | `views.py:256-526` |
| Екран 3: Результати (ваги, узгодженість, рекомендації) | Opys_Рівень.doc | `class ResultsWindow` з 3 вкладками | `views.py:528-703` |
| Візуалізація інформативності шкали | РЗОД-2011-2.pdf | Мітка з текстом "Інформативність: X біт" | `views.py:370-376`, `views.py:473-476` |
| Лінгвістичні фрази для градацій | РЗОД-2011-3.pdf | `LINGUISTIC_LABELS` dictionary | `models.py:348-366`, `views.py:461-467` |
| **Експорт даних** |
| Експорт ваг у CSV | Opys_Рівень.doc | `weights.csv` з колонками rank, alternative, weight | `controllers.py:254-263` |
| Експорт узгодженості у JSON | РЗОД-2011-4.pdf | `consistency.json` з λ_max, CI, CR, матрицею | `controllers.py:266-274` |
| Експорт рекомендацій у JSON | РЗОД-2011-4.pdf | `suggestions.json` з порівняннями та відхиленнями | `controllers.py:277-279` |
| Експорт трансформацій шкал | РЗОД-2011-4.pdf | `scale_transformations.json` з деталями уніфікації | `controllers.py:282-304` |
| **Збереження сесії** |
| Збереження стану експертизи | Opys_Рівень.doc | `save_session()`, JSON з альтернативами, експертами, оцінками | `models.py:280-294` |
| Завантаження сесії | Opys_Рівень.doc | `load_session()`, відновлення з JSON | `models.py:296-338` |

## Науковий фундамент

### Формула уніфікації (РЗОД-2011-4.pdf)
M_i^n = 1.5 + (i - 0.5) × 8 / n

### Інформативність шкали (РЗОД-2011-2.pdf)
I = log₂ N (формула Хартлі)

### Спектральний показник узгодженості (РЗОД-2011-4.pdf)
- λ_max - максимальне власне значення
- CI = (λ_max - n) / (n - 1)
- CR = CI / RI

### Вага експертної оцінки (РЗОД-2011-4.pdf)
w = I × c_l = log₂(N) × c_l

де:
- I - інформативність шкали
- c_l - коефіцієнт компетентності експерта

### Геометричне середнє зважене (РЗОД-2012-1.pdf)
GM = (∏ v_i^w_i)^(1/∑w_i)

## Демонстрація GUI

### Швидкий старт (приклад з 4 альтернативами, 2 експертами):

1. Запустіть GUI:
   ```bash
   python -m gui.app
   ```

2. Натисніть "Нова експертиза"

3. На екрані налаштування натисніть "Приклад (4 альтернативи)" - це автоматично:
   - Завантажить 4 альтернативи: Проект_A, Проект_B, Проект_C, Проект_D
   - Додасть 2 експертів:
     - Експерт_1 (компетентність: 0.85)
     - Експерт_2 (компетентність: 0.60)

4. Натисніть "Почати порівняння"

5. Виконайте парні порівняння:
   - Для кожної пари виберіть шкалу (наприклад, Сааті-9)
   - Перемістіть слайдер для вибору переваги
   - Спробуйте кнопку "Уточнити ступінь" для збільшення детальності
   - Натисніть "Підтвердити" або Enter

6. Після завершення всіх порівнянь переглянете результати:
   - Ваги та ранжування альтернатив
   - Показники узгодженості (λ_max, CI, CR)
   - Рекомендації для покращення (якщо потрібно)

7. Експортуйте результати у вибрану директорію

### Приклад з різними шкалами (6 доступних шкал):

Спробуйте використовувати різні шкали для різних порівнянь:
- **Ординальна (2)**: коли впевнені тільки в напрямку переваги (I = 1 біт)
- **Цілочислова/Сааті-9 (3)**: для базової деталізації (I = 1.58 біт)
- **Цілочислова/Сааті-9 (5)**: для помірної деталізації (I = 2.32 біт)
- **Цілочислова/Сааті-9 (9)**: для максимальної точності (I = 3.17 біт)
- **Збалансована/Степенева/Ма-Чженга/Донегана**: для специфічних випадків з альтернативним розподілом градацій

Система автоматично врахує інформативність кожної шкали при агрегації!

**Покрокове уточнення** (згідно Opys_Рівень.doc та РЗОД-2011-2.pdf):
- Почніть з ординальної (2 градації) → перейдіть до Сааті-9 (3) → уточніть до (5) → (7) → (9)
- Кнопка "Уточнити ступінь" автоматично пропонує наступний крок уточнення

### Збереження та продовження сесії:

1. Під час порівнянь можна закрити вікно
2. При наступному запуску виберіть "Відкрити існуючу..."
3. Завантажте збережений JSON файл
4. Продовжте з місця зупинки

## Автор

Курсова робота з теми: "Метод експертних попарних порівнянь з уточненням ступеня переваги"

## Ліцензія

Для навчальних цілей
